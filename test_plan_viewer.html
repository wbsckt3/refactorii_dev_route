<script>
  document.addEventListener('DOMContentLoaded', () => {
    fetch('plan.json')
      .then(response => response.json())
      .then(aiOutput => {
        renderMarkdownFromAIOutput(aiOutput.exercises);
      })
      .catch(error => {
        console.error('Error al cargar plan.json:', error);
      });
  });

  function renderMarkdownFromAIOutput(exercisesMarkdown) {
    const markdownOutputDiv = document.getElementById('markdown-output');

    // Limpieza opcional para algunos lenguajes embebidos
    exercisesMarkdown = exercisesMarkdown.replace(/\\n(sql|json|javascript|yaml|mermaid|gherkin)\\n/g, '\n');

    marked.setOptions({
      highlight: function(code, lang) {
        if (lang === 'mermaid') return code;
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return code;
      },
      langPrefix: 'language-',
      gfm: true,
      breaks: true
    });

    const renderer = new marked.Renderer();

    renderer.heading = function (text, level) {
      let icon = '';
      if (level === 1) icon = '📝';
      if (level === 2) {
        if (text.includes('Escenario de Prueba')) icon = '🔍';
        else if (text.includes('Estrategia de Automatización')) icon = '🤖';
        else if (text.includes('Diseño Técnico')) icon = '💻';
        else if (text.includes('Integración CI/CD')) icon = '🔄';
        else if (text.includes('Código Base')) icon = '🖥️';
        else if (text.includes('Métricas y Monitoreo')) icon = '📊';
      }
      return `<h${level}><span class="header-icon">${icon}</span>${text}</h${level}>`;
    };

    const htmlContent = marked.parse(exercisesMarkdown, { renderer: renderer });
    markdownOutputDiv.innerHTML = htmlContent;

    mermaid.initialize({ startOnLoad: true });
  }
</script>
